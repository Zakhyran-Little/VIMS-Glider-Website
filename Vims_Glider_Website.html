<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Interactive Map Marker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .header-controls {
            display: flex;
            gap: 10px;
        }
        .content {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }
        #map {
            flex: 1;
            height: 100%;
            min-height: 0;
        }
        .sidebar {
            width: 300px;
            background-color: #f5f5f5;
            padding: 1rem;
            overflow-y: auto;
        }
        .marker-list {
            margin-top: 1rem;
        }
        .marker-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .marker-item h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        .marker-item p {
            margin: 0.2rem 0;
        }
        .marker-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        button {
            padding: 0.5rem 1rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.delete {
            background-color: #e74c3c;
        }
        button.delete:hover {
            background-color: #c0392b;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .instructions {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        .coordinate-controls {
            background-color: #fff;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .coordinate-fields {
            display: flex;
            gap: 10px;
        }
        .coordinate-input {
            flex: 1;
        }
        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .marker-item .category {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        .undo-redo-controls {
            margin-left: 10px;
            display: flex;
            gap: 5px;
        }
        .mission-controls {
            background-color: #fff;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .path-toggle {
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>Global Interactive Map Marker</h1>
            <div class="header-controls">
                <button id="export-button">Export Markers</button>
                <button id="import-button">Import Markers</button>
                <button id="clear-button">Clear All</button>
                <div class="undo-redo-controls">
                    <button id="undo-button">Undo</button>
                    <button id="redo-button">Redo</button>
                </div>
            </div>
        </header>
        <div class="content">
            <div id="map"></div>
            <div class="sidebar">
                <div class="instructions">
                    <h3>Instructions:</h3>
                    <p>Click anywhere on the map to create a new marker, or use the coordinate controls below.</p>
                    <p>You can edit or delete existing markers from the list below.</p>
                </div>
                <div class="coordinate-controls">
                    <h3>Go To Coordinates</h3>
                    <div class="coordinate-fields">
                        <div class="coordinate-input">
                            <label for="goto-lat">Latitude:</label>
                            <input type="number" id="goto-lat" step="0.000001" min="-90" max="90" placeholder="e.g., 40.7128">
                        </div>
                        <div class="coordinate-input">
                            <label for="goto-lng">Longitude:</label>
                            <input type="number" id="goto-lng" step="0.000001" min="-180" max="180" placeholder="e.g., -74.0060">
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button id="goto-button" style="flex: 1;">Go To Location</button>
                        <button id="add-at-coords" style="flex: 1;">Add Marker Here</button>
                    </div>
                </div>
                <div class="mission-controls">
                    <h3>Mission Filter</h3>
                    <div class="form-group">
                        <label for="mission-select">Select Mission:</label>
                        <select id="mission-select">
                            <option value="all">All Missions</option>
                        </select>
                    </div>
                    <div class="path-toggle">
                        <input type="checkbox" id="show-path" checked>
                        <label for="show-path">Show Mission Path</label>
                    </div>
                </div>
                <div id="marker-form" style="display: none;">
                    <h2>Marker Details</h2>
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" placeholder="Enter a title">
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" rows="3" placeholder="Enter a description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">Date (optional):</label>
                        <input type="date" id="date">
                    </div>
                    <div class="form-group">
                        <label for="category">Category:</label>
                        <select id="category">
                            <option value="red">Red (Default)</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="yellow">Yellow</option>
                            <option value="purple">Purple</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mission">Mission:</label>
                        <input type="text" id="mission" placeholder="Enter mission name">
                    </div>
                    <div class="form-group">
                        <label>Coordinates:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="marker-lat" step="0.000001" min="-90" max="90" placeholder="Latitude">
                            <input type="number" id="marker-lng" step="0.000001" min="-180" max="180" placeholder="Longitude">
                        </div>
                    </div>
                    <button id="save-marker">Save Marker</button>
                    <button id="cancel-marker">Cancel</button>
                </div>
                <h2>Your Markers</h2>
                <div id="marker-list" class="marker-list">
                    <p>No markers added yet. Click on the map to add one.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Initialize variables
        let markers = [];
        let currentMarker = null;
        let editingMarker = null;
        let history = [];
        let historyIndex = -1;
        let polylines = {};

        // Initialize map
        let map = L.map('map', {
            worldCopyJump: true,
            minZoom: 1
        }).setView([0, 0], 2);

        // Define map types
        const mapTypes = [
            { name: 'ArcGIS World Street Map', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri' },
            { name: 'ArcGIS World Imagery', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri' },
            { name: 'ArcGIS Topographic', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri' },
            { name: 'ArcGIS Terrain Base', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri' },
            { name: 'ArcGIS Ocean Base', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri' },
            { name: 'ArcGIS Shaded Relief', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri' },
            { name: 'ArcGIS Physical Map', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri' },
            { name: 'ArcGIS National Geographic', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles © Esri — National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC' }
        ];

        let baseMaps = {};
        let currentBaseLayer = null;
        let boundaryLayer = null;

        // Add base layers
        mapTypes.forEach((mapType, index) => {
            const layer = L.tileLayer(mapType.url, {
                attribution: mapType.attribution,
                noWrap: false
            });
            baseMaps[mapType.name] = layer;
            if (index === 0) {
                currentBaseLayer = layer;
                layer.addTo(map);
            }
        });

        // Add boundary layer
        boundaryLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Boundaries © Esri',
            pane: 'overlayPane'
        });

        // DOM elements
        const markerForm = document.getElementById('marker-form');
        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const dateInput = document.getElementById('date');
        const categoryInput = document.getElementById('category');
        const missionInput = document.getElementById('mission');
        const markerLatInput = document.getElementById('marker-lat');
        const markerLngInput = document.getElementById('marker-lng');
        const saveButton = document.getElementById('save-marker');
        const cancelButton = document.getElementById('cancel-marker');
        const markerList = document.getElementById('marker-list');
        const gotoLatInput = document.getElementById('goto-lat');
        const gotoLngInput = document.getElementById('goto-lng');
        const gotoButton = document.getElementById('goto-button');
        const addAtCoordsButton = document.getElementById('add-at-coords');
        const exportButton = document.getElementById('export-button');
        const importButton = document.getElementById('import-button');
        const clearButton = document.getElementById('clear-button');
        const undoButton = document.getElementById('undo-button');
        const redoButton = document.getElementById('redo-button');
        const missionSelect = document.getElementById('mission-select');
        const showPathCheckbox = document.getElementById('show-path');

        // Set initial coordinates
        const initialCenter = map.getCenter();
        gotoLatInput.value = initialCenter.lat.toFixed(6);
        gotoLngInput.value = initialCenter.lng.toFixed(6);

        // Map click event
        map.on('click', function(e) {
            createTemporaryMarker(e.latlng.lat, e.latlng.lng);
        });

        // Go to coordinates
        gotoButton.addEventListener('click', function() {
            const lat = parseFloat(gotoLatInput.value);
            const lng = parseFloat(gotoLngInput.value);
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinates. Latitude: -90 to 90, Longitude: -180 to 180');
                return;
            }
            map.setView([lat, lng], map.getZoom());
        });

        // Add marker at coordinates
        addAtCoordsButton.addEventListener('click', function() {
            const lat = parseFloat(gotoLatInput.value);
            const lng = parseFloat(gotoLngInput.value);
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinates. Latitude: -90 to 90, Longitude: -180 to 180');
                return;
            }
            createTemporaryMarker(lat, lng);
        });

        function createTemporaryMarker(lat, lng) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            currentMarker = L.marker([lat, lng]).addTo(map);
            markerForm.style.display = 'block';
            titleInput.value = '';
            descriptionInput.value = '';
            dateInput.value = '';
            categoryInput.value = 'red';
            missionInput.value = '';
            markerLatInput.value = lat.toFixed(6);
            markerLngInput.value = lng.toFixed(6);
            editingMarker = null;
        }

        function getMarkerIcon(category) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${category}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        saveButton.addEventListener('click', function() {
            const title = titleInput.value.trim();
            const lat = parseFloat(markerLatInput.value);
            const lng = parseFloat(markerLngInput.value);
            const category = categoryInput.value;
            
            if (!title) {
                alert('Please enter a title for your marker.');
                return;
            }
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinates. Latitude: -90 to 90, Longitude: -180 to 180');
                return;
            }
            
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            const newMapMarker = L.marker([lat, lng], { icon: getMarkerIcon(category) }).addTo(map);
            
            const marker = {
                id: editingMarker ? editingMarker.id : Date.now(),
                title: title,
                description: descriptionInput.value.trim(),
                date: dateInput.value,
                category: category,
                mission: missionInput.value.trim() || 'Unassigned',
                lat: lat,
                lng: lng,
                mapMarker: newMapMarker
            };
            
            if (editingMarker) {
                markers = markers.filter(m => m.id !== editingMarker.id);
            }
            
            newMapMarker.bindPopup(`
                <strong>${marker.title}</strong><br>
                ${marker.description ? marker.description + '<br>' : ''}
                ${marker.date ? 'Date: ' + marker.date + '<br>' : ''}
                ${marker.mission ? 'Mission: ' + marker.mission + '<br>' : ''}
                <small>Lat: ${marker.lat.toFixed(6)}, Lng: ${marker.lng.toFixed(6)}</small>
            `);
            
            markers.push(marker);
            addToHistory();
            currentMarker = null;
            updateMarkerList();
            updateMissionSelect();
            updatePaths();
            saveMarkersToLocalStorage();
            markerForm.style.display = 'none';
        });

        cancelButton.addEventListener('click', function() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            markerForm.style.display = 'none';
        });

        function updateMarkerList() {
            if (markers.length === 0) {
                markerList.innerHTML = '<p>No markers added yet. Click on the map to add one.</p>';
                return;
            }
            
            markerList.innerHTML = '';
            
            markers.forEach(marker => {
                const item = document.createElement('div');
                item.className = 'marker-item';
                item.innerHTML = `
                    <h3><span class="category" style="background-color: ${marker.category};"></span>${marker.title}</h3>
                    ${marker.description ? '<p>' + marker.description + '</p>' : ''}
                    ${marker.date ? '<p>Date: ' + marker.date + '</p>' : ''}
                    ${marker.mission ? '<p>Mission: ' + marker.mission + '</p>' : ''}
                    <p>Lat: ${marker.lat.toFixed(6)}, Lng: ${marker.lng.toFixed(6)}</p>
                    <div class="marker-actions">
                        <button class="fly-to" data-id="${marker.id}">Fly To</button>
                        <button class="edit" data-id="${marker.id}">Edit</button>
                        <button class="delete" data-id="${marker.id}">Delete</button>
                    </div>
                `;
                
                markerList.appendChild(item);
                
                item.querySelector('.fly-to').addEventListener('click', function() {
                    map.flyTo([marker.lat, marker.lng], 10);
                });
                
                item.querySelector('.edit').addEventListener('click', function() {
                    editMarker(marker.id);
                });
                
                item.querySelector('.delete').addEventListener('click', function() {
                    deleteMarker(marker.id);
                });
            });
        }

        function editMarker(id) {
            const marker = markers.find(m => m.id === id);
            if (!marker) return;
            
            currentMarker = marker.mapMarker;
            editingMarker = marker;
            
            titleInput.value = marker.title;
            descriptionInput.value = marker.description;
            dateInput.value = marker.date;
            categoryInput.value = marker.category;
            missionInput.value = marker.mission || '';
            markerLatInput.value = marker.lat.toFixed(6);
            markerLngInput.value = marker.lng.toFixed(6);
            
            markerForm.style.display = 'block';
            map.flyTo([marker.lat, marker.lng], 10);
        }

        function deleteMarker(id) {
            const marker = markers.find(m => m.id === id);
            if (!marker) return;
            
            map.removeLayer(marker.mapMarker);
            markers = markers.filter(m => m.id !== id);
            addToHistory();
            updateMarkerList();
            updateMissionSelect();
            updatePaths();
            saveMarkersToLocalStorage();
        }

        function updateMissionSelect() {
            const missions = [...new Set(markers.map(m => m.mission || 'Unassigned'))].sort();
            const currentSelection = missionSelect.value;
            
            while (missionSelect.options.length > 1) {
                missionSelect.remove(1);
            }
            
            missions.forEach(mission => {
                const option = document.createElement('option');
                option.value = mission;
                option.textContent = mission;
                missionSelect.appendChild(option);
            });
            
            if (missions.includes(currentSelection)) {
                missionSelect.value = currentSelection;
            }
            updatePaths();
        }

        function drawPathForMission(mission) {
            // Remove existing polyline for this mission
            if (polylines[mission]) {
                map.removeLayer(polylines[mission]);
                delete polylines[mission];
            }
            
            // Get markers for the mission
            const missionMarkers = markers.filter(m => m.mission === mission);
            
            if (missionMarkers.length < 2) return; // Need at least 2 markers for a path
            
            // Sort markers by date (if available) or id
            missionMarkers.sort((a, b) => {
                if (a.date && b.date) {
                    return new Date(a.date) - new Date(b.date);
                }
                return a.id - b.id;
            });
            
            // Create coordinates array
            const coords = missionMarkers.map(m => [m.lat, m.lng]);
            
            // Draw polyline
            polylines[mission] = L.polyline(coords, {
                color: 'blue',
                weight: 3,
                opacity: 0.7
            });
            
            if (showPathCheckbox.checked) {
                polylines[mission].addTo(map);
            }
        }

        function updatePaths() {
            // Update paths for all missions
            const missions = [...new Set(markers.map(m => m.mission || 'Unassigned'))];
            missions.forEach(mission => {
                if (missionSelect.value === 'all' || missionSelect.value === mission) {
                    drawPathForMission(mission);
                } else {
                    if (polylines[mission]) {
                        map.removeLayer(polylines[mission]);
                        delete polylines[mission];
                    }
                }
            });
        }

        function filterMarkersByMission(missionName) {
            const visibleMarkersIds = [];
            
            markers.forEach(marker => {
                const isVisible = missionName === 'all' || marker.mission === missionName;
                if (isVisible) {
                    marker.mapMarker.addTo(map);
                    visibleMarkersIds.push(marker.id);
                } else {
                    map.removeLayer(marker.mapMarker);
                }
            });
            
            document.querySelectorAll('.marker-item').forEach(item => {
                const markerId = parseInt(item.querySelector('.fly-to').dataset.id);
                item.style.display = visibleMarkersIds.includes(markerId) ? 'block' : 'none';
            });
            
            if (visibleMarkersIds.length === 0 && markers.length > 0) {
                const noResults = document.createElement('p');
                noResults.textContent = `No markers found for mission "${missionName}".`;
                markerList.appendChild(noResults);
            }
            
            updatePaths();
        }

        missionSelect.addEventListener('change', function() {
            filterMarkersByMission(this.value);
        });

        showPathCheckbox.addEventListener('change', function() {
            updatePaths();
        });

        exportButton.addEventListener('click', function() {
            if (markers.length === 0) {
                alert('No markers to export.');
                return;
            }
            
            const data = markers.map(marker => ({
                id: marker.id,
                title: marker.title,
                description: marker.description,
                date: marker.date,
                category: marker.category,
                mission: marker.mission,
                lat: marker.lat,
                lng: marker.lng
            }));
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'map-markers.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        importButton.addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) {
                            throw new Error('Invalid data format');
                        }
                        
                        markers.forEach(marker => map.removeLayer(marker.mapMarker));
                        markers = [];
                        Object.keys(polylines).forEach(mission => {
                            if (polylines[mission]) {
                                map.removeLayer(polylines[mission]);
                            }
                        });
                        polylines = {};
                        
                        importedData.forEach(item => {
                            if (!item.title || !item.lat || !item.lng) {
                                console.warn('Skipping invalid marker:', item);
                                return;
                            }
                            
                            const mapMarker = L.marker([item.lat, item.lng], { icon: getMarkerIcon(item.category || 'red') }).addTo(map);
                            const marker = {
                                id: item.id || Date.now() + Math.random(),
                                title: item.title,
                                description: item.description || '',
                                date: item.date || '',
                                category: item.category || 'red',
                                mission: item.mission || 'Unassigned',
                                lat: item.lat,
                                lng: item.lng,
                                mapMarker: mapMarker
                            };
                            
                            mapMarker.bindPopup(`
                                <strong>${marker.title}</strong><br>
                                ${marker.description ? marker.description + '<br>' : ''}
                                ${marker.date ? 'Date: ' + marker.date + '<br>' : ''}
                                ${marker.mission ? 'Mission: ' + marker.mission + '<br>' : ''}
                                <small>Lat: ${marker.lat.toFixed(6)}, Lng: ${marker.lng.toFixed(6)}</small>
                            `);
                            
                            markers.push(marker);
                        });
                        
                        addToHistory();
                        updateMarkerList();
                        updateMissionSelect();
                        updatePaths();
                        saveMarkersToLocalStorage();
                        
                        if (markers.length > 0) {
                            const group = new L.featureGroup(markers.map(m => m.mapMarker));
                            map.fitBounds(group.getBounds().pad(0.2));
                        }
                        
                        alert(`Successfully imported ${markers.length} markers.`);
                    } catch (error) {
                        alert('Error importing markers: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        });

        function saveMarkersToLocalStorage() {
            localStorage.setItem('mapMarkers', JSON.stringify(markers.map(marker => ({
                id: marker.id,
                title: marker.title,
                description: marker.description,
                date: marker.date,
                category: marker.category,
                mission: marker.mission,
                lat: marker.lat,
                lng: marker.lng
            }))));
        }

        function loadMarkersFromLocalStorage() {
            try {
                const savedMarkers = localStorage.getItem('mapMarkers');
                if (savedMarkers) {
                    const importedData = JSON.parse(savedMarkers);
                    if (!Array.isArray(importedData)) {
                        throw new Error('Invalid data format');
                    }
                    
                    importedData.forEach(item => {
                        if (!item.title || isNaN(item.lat) || isNaN(item.lng)) {
                            console.warn('Skipping invalid marker:', item);
                            return;
                        }
                        
                        const mapMarker = L.marker([item.lat, item.lng], { icon: getMarkerIcon(item.category || 'red') }).addTo(map);
                        const marker = {
                            id: item.id || Date.now() + Math.random(),
                            title: item.title,
                            description: item.description || '',
                            date: item.date || '',
                            category: item.category || 'red',
                            mission: item.mission || 'Unassigned',
                            lat: parseFloat(item.lat),
                            lng: parseFloat(item.lng),
                            mapMarker: mapMarker
                        };
                        
                        mapMarker.bindPopup(`
                            <strong>${marker.title}</strong><br>
                            ${marker.description ? marker.description + '<br>' : ''}
                            ${marker.date ? 'Date: ' + marker.date + '<br>' : ''}
                            ${marker.mission ? 'Mission: ' + marker.mission + '<br>' : ''}
                            <small>Lat: ${marker.lat.toFixed(6)}, Lng: ${marker.lng.toFixed(6)}</small>
                        `);
                        
                        markers.push(marker);
                    });
                    
                    if (markers.length > 0) {
                        addToHistory();
                    }
                    
                    updateMarkerList();
                    updateMissionSelect();
                    updatePaths();
                }
            } catch (error) {
                console.error('Error loading markers from local storage:', error);
                localStorage.removeItem('mapMarkers');
            }
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker.mapMarker));
            Object.keys(polylines).forEach(mission => {
                if (polylines[mission]) {
                    map.removeLayer(polylines[mission]);
                }
            });
            markers = [];
            polylines = {};
            history = [];
            historyIndex = -1;
            localStorage.removeItem('mapMarkers');
            updateMarkerList();
            updateMissionSelect();
            updateUndoRedoButtons();
        }

        function addToHistory() {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            const markersCopy = markers.map(marker => ({
                id: marker.id,
                title: marker.title,
                description: marker.description,
                date: marker.date,
                category: marker.category,
                mission: marker.mission,
                lat: marker.lat,
                lng: marker.lng
            }));
            
            history.push(markersCopy);
            historyIndex = history.length - 1;
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            undoButton.disabled = historyIndex <= 0;
            redoButton.disabled = historyIndex >= history.length - 1;
        }

        undoButton.addEventListener('click', function() {
            if (historyIndex <= 0) return;
            
            historyIndex--;
            restoreFromHistory();
            updateUndoRedoButtons();
        });

        redoButton.addEventListener('click', function() {
            if (historyIndex >= history.length - 1) return;
            
            historyIndex++;
            restoreFromHistory();
            updateUndoRedoButtons();
        });

        function restoreFromHistory() {
            markers.forEach(marker => map.removeLayer(marker.mapMarker));
            Object.keys(polylines).forEach(mission => {
                if (polylines[mission]) {
                    map.removeLayer(polylines[mission]);
                }
            });
            markers = [];
            polylines = {};
            
            const historicMarkers = history[historyIndex];
            historicMarkers.forEach(item => {
                const mapMarker = L.marker([item.lat, item.lng], { icon: getMarkerIcon(item.category || 'red') }).addTo(map);
                const marker = {
                    id: item.id,
                    title: item.title,
                    description: item.description || '',
                    date: item.date || '',
                    category: item.category || 'red',
                    mission: item.mission || 'Unassigned',
                    lat: item.lat,
                    lng: item.lng,
                    mapMarker: mapMarker
                };
                
                mapMarker.bindPopup(`
                    <strong>${marker.title}</strong><br>
                    ${marker.description ? marker.description + '<br>' : ''}
                    ${marker.date ? 'Date: ' + marker.date + '<br>' : ''}
                    ${marker.mission ? 'Mission: ' + marker.mission + '<br>' : ''}
                    <small>Lat: ${marker.lat.toFixed(6)}, Lng: ${marker.lng.toFixed(6)}</small>
                `);
                
                markers.push(marker);
            });
            
            updateMarkerList();
            updateMissionSelect();
            updatePaths();
            saveMarkersToLocalStorage();
        }

        clearButton.addEventListener('click', function() {
            if (markers.length === 0) {
                alert('No markers to clear.');
                return;
            }
            
            if (confirm('Are you sure you want to clear all markers? This is not an action that can be undone.')) {
                clearMarkers();
            }
        });

        function validateCoordinates(lat, lng) {
            if (isNaN(lat) || isNaN(lng)) {
                return 'Please enter numeric values for coordinates.';
            }
            
            if (lat < -90 || lat > 90) {
                return 'Latitude must be between -90 and 90 degrees.';
            }
            
            if (lng < -180 || lng > 180) {
                return 'Longitude must be between -180 and 180 degrees.';
            }
            
            return null;
        }

        // Add map controls
        const mapControlsDiv = document.createElement('div');
        mapControlsDiv.className = 'map-controls';
        document.querySelector('.content').appendChild(mapControlsDiv);

        const mapTypeSelector = document.createElement('select');
        mapTypeSelector.id = 'base-layer-select';
        mapControlsDiv.appendChild(mapTypeSelector);

        mapTypes.forEach((mapType, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = mapType.name;
            mapTypeSelector.appendChild(option);
        });

        mapTypeSelector.addEventListener('change', function() {
            const layerIndex = parseInt(this.value);
            const selectedType = mapTypes[layerIndex];

            if (currentBaseLayer) {
                map.removeLayer(currentBaseLayer);
            }

            currentBaseLayer = L.tileLayer(selectedType.url, {
                attribution: selectedType.attribution,
                noWrap: false
            }).addTo(map);

            // Add boundary layer for specific map types
            if (['ArcGIS World Imagery', 'ArcGIS Shaded Relief', 'ArcGIS Physical Map'].includes(selectedType.name)) {
                boundaryLayer.addTo(map);
            } else {
                map.removeLayer(boundaryLayer);
            }

            if (boundaryLayer) {
                boundaryLayer.bringToFront();
            }
        });

        // Add zoom controls
        const zoomControls = document.createElement('div');
        zoomControls.style.display = 'flex';
        zoomControls.style.gap = '5px';
        zoomControls.style.marginLeft = '10px';

        const zoomInButton = document.createElement('button');
        zoomInButton.textContent = '+';
        zoomInButton.style.padding = '2px 8px';
        zoomInButton.addEventListener('click', function() {
            map.zoomIn();
        });

        const zoomOutButton = document.createElement('button');
        zoomOutButton.textContent = '−';
        zoomOutButton.style.padding = '2px 8px';
        zoomOutButton.addEventListener('click', function() {
            map.zoomOut();
        });

        zoomControls.appendChild(zoomOutButton);
        zoomControls.appendChild(zoomInButton);

        // Add boundary toggle
        const boundaryToggleContainer = document.createElement('div');
        boundaryToggleContainer.style.display = 'flex';
        boundaryToggleContainer.style.alignItems = 'center';
        boundaryToggleContainer.style.marginLeft = '10px';

        const boundaryCheckbox = document.createElement('input');
        boundaryCheckbox.type = 'checkbox';
        boundaryCheckbox.id = 'boundary-toggle';
        boundaryCheckbox.checked = true;
        boundaryCheckbox.style.marginRight = '5px';

        const boundaryLabel = document.createElement('label');
        boundaryLabel.htmlFor = 'boundary-toggle';
        boundaryLabel.textContent = 'Show Boundaries';

        boundaryCheckbox.addEventListener('change', function() {
            if (this.checked) {
                boundaryLayer.addTo(map);
            } else {
                map.removeLayer(boundaryLayer);
            }
        });

        boundaryToggleContainer.appendChild(boundaryCheckbox);
        boundaryToggleContainer.appendChild(boundaryLabel);

        // Add controls to container
        const mapTypeSelectorLabel = document.createElement('label');
        mapTypeSelectorLabel.textContent = 'Map Type: ';
        mapTypeSelectorLabel.style.marginRight = '5px';

        mapControlsDiv.appendChild(mapTypeSelectorLabel);
        mapControlsDiv.appendChild(mapTypeSelector);
        mapControlsDiv.appendChild(zoomControls);
        mapControlsDiv.appendChild(boundaryToggleContainer);

        // Initialize app
        function initializeApp() {
            loadMarkersFromLocalStorage();
            updateUndoRedoButtons();
            
            if (markers.length > 0) {
                const group = new L.featureGroup(markers.map(m => m.mapMarker));
                map.fitBounds(group.getBounds().pad(0.2));
            }

            // Add boundary layer initially for specific map types
            if (['ArcGIS World Imagery', 'ArcGIS Shaded Relief', 'ArcGIS Physical Map'].includes(mapTypes[0].name)) {
                boundaryLayer.addTo(map);
            }
        }

        // Call initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            map.invalidateSize();
            initializeApp();
        });
    </script>
</body>
</html>
